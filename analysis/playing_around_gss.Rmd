---
title: "Examples of wrangling GSS data"
author: "Gary Lupyan"
date: "10/19/2021"
output: 
  html_document:
    toc: yes
    toc_float: yes
    theme: cerulean
    number_sections: no
    css: style.css
---

```{r message=FALSE, warning=FALSE}
library(foreign)
library(Hmisc)
library(sjmisc)
library(tidyverse)
library(ggplot2)
library(DT)
```

# Load in data

We're loading in the SPSS-formatted data from GSS year 2018. Need foreign::spss.get to read the data
```{r message=FALSE, warning=FALSE, echo=FALSE}
gss <- spss.get("../data/GSS2018.sav", use.value.labels=TRUE,lowernames=TRUE)
```

# Two things to watch out for when importing data

## Data types

Whenever we're loading in data from external sources, especially data as complex as the GSS, we need to make sure that we're importing what we think we're importing. Let's look at a couple variables and see what kind of errors we could accidentally make


The variable `age` is the respondent's age. Simple enough. Let's try to plot the age distribution using `hist()`. Hmmm...

```{r include=FALSE}
#hist(gss$age)
```

Hmm.. what's going on?
```{r}
summary(gss$age)
```

Uh huh... how do we fix it?
What about this? Let's just assume that those >89 are 90. They're not, but it's better than just leaving them out of the analysis, so....
```{r}
gss$age_recoded = gss$age %>% 
  fct_recode("90"="89 OR OLDER") %>%
  as.numeric

mean(gss$age_recoded,na.rm=TRUE)
```

Ok.. mean is 32.. seems reasonable? Is it correct though? Let's look at a histogram. What do you notice?
```{r}
hist(gss$age_recoded)
```


How do we fix this?

Now try it yourself by fixing the coding of `realrinc` (respondent's annual income adjusted to 1986 dollars).

```{r}
gss$age_recoded = gss$age %>% 
  fct_recode("90"="89 OR OLDER") %>%
  as.character %>%
  as.numeric

mean(gss$age_recoded,na.rm=TRUE)
```

What's the mean and median income of participants younger than 25 in 2018 dollars? To get 2018 dollars (where these data are from), multiply realrinc (1986 dollars) by 2.29. 

```{r}
gss$age_recoded = gss$age %>% 
  fct_recode("90"="89 OR OLDER") %>% 
  as.character %>%
  as.numeric

gss <- gss %>% mutate(realrinc = as.numeric(as.character(realrinc)))
gss <- gss %>% mutate(realrinc_2016 = realrinc*2.29)
```

How many participants are there in this dataset who're younger than 25? 
 Break it down by the participant's gender (`sex`). Do you notice anything about the mean vs. median for males vs. females? What is this telling you?


Solution
```{r}
gss %>% filter(age_recoded<25) %>% 
  summarize(realrinc_2016_mean = mean(realrinc_2016,na.rm=TRUE),realrinc_2016_med = median(realrinc_2016,na.rm=TRUE),n=n())
```



## Factor levels

The variable `happy` contains participant's responses to this question:
`Taken all together, how would you say things are these days--would you say that you are very happy, pretty happy, or not too happy?`

It's coded as those three levels
```{r}
levels(gss$happy)
```


Let's look at respondents' happiness as a function of self-reported health (`health`)
```{r}
gss %>% drop_na(health) %>% group_by(health) %>% summarize(happy = mean(as.numeric(happy),na.rm=TRUE))
```

See the problem?
```{r}
levels(gss$happy)
```

Let's fix it:

```{r}
gss$happy_rev <- fct_rev(gss$happy)
```


# Do people know that the earth goes around the sun?

Ok, let's switch gearts a bit. Let's look at some relationships between `degree` (participant's education level) and their knowledge of whether the earth goes around the sun or the sun goes around the earth (`earthsun`)


## Contingency tables using base R
The first way we can do this is by using contingency tables found in the base package which by default will show us frequencies:
```{r}
gss %>% xtabs(~degree+earthsun,data=.) 
```

or more usefully, proportions (notice how we're piping in the `xtabs` output into `prop.table`)
```{r}
gss %>% xtabs(~degree+earthsun,data=.) %>% prop.table(margin=1) %>% round(2)
```
People with less than a high school degree are at chance on this question... What does this mean?). Is that more or less troubling than that 7% of people with graduate degrees get this wrong? (not a rhetorical question!)

## Contingency tables using `sjmisc`

Here's what the same tabulation looks like using the `sjmisc` package which provides us some nice additional features:
```{r}
gss %>% flat_table(degree,earthsun)
```

..and proportions:
```{r}
gss %>% flat_table(degree,earthsun,margin=c("row"),digits=0) #the digits argument is the number of significant digits
```

`sjmisc` has additional grouping functions that allow us to split a variable into equal groups. Let's do this for `degree`. Note that we need to first convert it to numeric.
```{r}
gss %>% transform(degree=as.numeric(degree)) %>% 
  split_var(degree,n=3,val.labels = c("Lowest tertile","Middle tertle", "Highest tertile")) %>% 
  flat_table(degree_g,earthsun,margin=c("row"),digits=1)

```

## Contingency tables using `dplyr`

Here's what a basic contingency table looks like with `dplyr`
```{r}
gss %>% group_by(degree,earthsun) %>% summarize(n=n())
```

Let's get rid of those NAs:
```{r}
gss %>% group_by(degree,earthsun) %>% drop_na(degree,earthsun) %>% summarize(n=n())
```

Let's convert to proportions:
```{r}
gss %>% group_by(degree,earthsun) %>% drop_na(degree,earthsun) %>% summarize(n=n()) %>% 
    mutate(proportion = n / sum(n)) 
```

Notice that the data are in a `long` format. This is exactly what we want for graphing and statistical analyses, but if you want a more readable table, just pivot it like so:
```{r}
gss %>% group_by(degree,earthsun) %>% drop_na(degree,earthsun) %>% 
    summarize(n=n()) %>% mutate(proportion = n / sum(n)) %>% 
  select(-n) %>% #get rid of the number of observations column since we're using proportions here 
    pivot_wider(names_from=earthsun,values_from=proportion)  

```


## Human evolution, politics, education
Let's look at another relationship: endorsement of the statement "human beings developed from animals" (`evolved`) and see how it relates to political party affiliation (`partyid`)
```{r}
gss %>% flat_table(polviews,evolved,margin=c("row"),digits=1)
```

Let's see how the likelihood of endorsing human evolution is affected by education (`degree`):
```{r}
gss %>% group_by(degree) %>% drop_na(degree,evolved) %>% summarize(evolved=round(mean(evolved=="True",na.rm=TRUE),2),n=n())
```

Now let's see whether education has a differential effect for people of various political orientations. For simplicity let's dichotomize education into respondents with a college degree or above, and those below a college degree:
```{r}
gss %>% drop_na(polviews,degree,evolved) %>%
    mutate(college_or_more = (as.numeric(degree) > 3)) %>%
    group_by(polviews,college_or_more) %>% 
    summarize(humans_evolved=round(mean(evolved=="True",na.rm=TRUE),2),n=n()) %>% 
  datatable(options = list(pageLength = 20)) #check this out in a browser!
```
**(notice the small Ns in some cells)**

This is the kind of data that's perfect for graphing to look at interactions. But we're examining it in table form, we can pivot it to wide and make a difference column, e.g
```{r}
gss %>% drop_na(polviews,degree,evolved) %>%
    mutate(college_or_more = (as.numeric(degree) > 3)) %>%
    group_by(polviews,college_or_more) %>% 
    summarize(humans_evolved=mean(evolved=="True",na.rm=TRUE)) %>%
    pivot_wider(names_from=college_or_more,values_from=humans_evolved) %>% rename("college_or_more" = `TRUE`, "lt_college" = `FALSE`) %>%
    mutate(evolution_diff = college_or_more - lt_college) 

```

What does a regression model look like in the tidyverse? Simple! Let's test for the main effects and interaction of `polviews` and `degree` on `evolution` using logistic regression (because our outcome variable is binary). We're going to use `scale` to center the variables. We don't need to explicitly use `drop_na` because glm will automatically drop missing values.
```{r}

gss %>% glm(I(evolved=="True")~scale(as.numeric(polviews))*scale(as.numeric(degree)),data=.,family=binomial) %>% summary

```


# Now it's your turn!

You can look up info on the variables at https://gssdataexplorer.norc.org/variables/vfilter If you just need to quickly look up the description of the variable use `head(gss$var_name)` or summary(gss$var_name) to list its factors (which will be listed in order). Note that when the data were imported from SPSS, all variables were imported as factors, hence the need to convert to numeric as needed.

## Children and happiness
Are people with children (`childs!=0`) happier (`happy`) than people without children? Does this relationship depend on the respondent's gender? (`sex`) Their age? (`age`)? 

::: {.notebox}
Note
Feel free to bin age into discrete groups (20-30, 31-40 etc.). The sjmisc package has nice functions for this. See the cheat sheet.
:::

```{r}

```


## Income and happiness

What's the relationship between respondent's income (`realrinc`) and happiness (`happy`)? Use `sjmisc::split_var` to bin income into quintiles (i.e., 5 equal groups). How does this relationship vary for people who have a college degree or higher vs. people who don't? 

::: {.notebox}
**Tip**
Remember to convert income to numeric using `as.numeric(as.character(realrinc)))` 
:::


::: {.notebox}
**Tip**
`realrinc` is income in 1986 dollars. To convert to 2018 dollars, multiply by 2.29. Also make sure you interpret the value of `happy` correctly.
:::

```{r}

```

## Politics and cynicism

Have a look at the variable `helpful`. What's the relationship between `helpful` and political party affiliation (`partyid`)? Notice something funny there) What about its relationship with religiosity (`god`)? Age (`age`)?

Since it's hard to interpret "DEPENDS" as an answer, let's focus on whether people are helpful or looking out for selves (the first two options).


```{r}

```


## Individual income, family income, and marital happiness
The data includes not only the respondent's income (`realrinc`), but also the family income (`realinc`) This allows you to figure out how much other members of the family (typically the spouse) is earning. Do respondents whose income is a larger proportion of the family income have a different marital satisfaction (`hapmar`)? 

```{r}

```



